# MICAL Test Suite

Language-independent test cases for MICAL implementations.

## Directory Structure

Each test case is a directory containing:

| File                 | Required | Description                                                          |
| -------------------- | -------- | -------------------------------------------------------------------- |
| `input.mical`        | yes      | Source input to parse and evaluate                                   |
| `output.json`        | yes      | Expected JSON output                                                 |
| `error.txt`          | no       | Expected diagnostic messages (one per line)                          |
| `input.broken.mical` | no       | Input that _should_ work but currently doesn't (excluded from tests) |

`cargo codegen` scans for directories containing `input.mical` and generates
snapshot test entry points. Directories with only `input.broken.mical` are
skipped.

## Test Categories

### block-string-\*

Block string (`|`, `>`) parsing with chomp indicators (`-`, `+`) and
various body/termination patterns.

Systematic tests follow a dimension-based naming convention:

```
block-string-{lines}-{style}-{chomp}-{body dimensions}-{termination}
```

See [block-string-test-matrix.md](block-string-test-matrix.md) for the
full dimension analysis. Tests are generated by
[generate-block-string-tests.rb](generate-block-string-tests.rb).

### key-value-\*

Key-value entry parsing: value types (boolean, integer, strings), key
formats (word, quoted, punctuation), indentation, and edge cases.

### prefix-block-\*

Prefix block (`{ }`) parsing: nesting, empty blocks, EOF handling, and
error recovery.

### Other

General tests: `basic-entries`, `comments-directives`, `duplicate-keys`,
`empty`, `shebang`, `typed-values`, etc.

## Adding a Test

1. Create a directory: `test-suite/{name}/`
2. Add `input.mical` and `output.json` (and `error.txt` if errors are expected)
3. Run `cargo codegen` to regenerate test entry points
4. Run `cargo xtest --workspace` to verify
5. Run `cargo insta review` to accept new snapshots

## Using from Other Implementations

This test suite is designed to be reusable across MICAL implementations in
any language. Each implementation should:

1. Read `input.mical`
2. Parse and evaluate it
3. Compare JSON output against `output.json`
4. If `error.txt` exists, verify that diagnostics match
